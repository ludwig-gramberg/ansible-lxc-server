<VirtualHost {{ item.public_ip }}:80>

	ServerAdmin {{ item.admin }}
	ServerName {{ item.domain }}
	{% if item.aliases is defined %}
	{% for alias in item.aliases %}
    ServerAlias {{ alias }}
    {% endfor %}
    {% endif %}

    ProxyRequests Off
    ProxyPreserveHost On
	ProxyPass {{ item.source_request|default('/') }} {{ item.target_request }} disableReuse=On retry=5
    ProxyPassReverse {{ item.source_request|default('/') }} {{ item.target_request }}
    ProxyVia On

    ErrorLog ${APACHE_LOG_DIR}/error.log
	LogLevel warn

</VirtualHost>

{% if item.ssl is defined %}
<VirtualHost {{ item.public_ip }}:443>

    ServerAdmin {{ item.admin }}
	ServerName {{ item.domain }}
	{% if item.aliases is defined %}
	{% for alias in item.aliases %}
	ServerAlias {{ alias }}
	{% endfor %}
	{% endif %}

    ProxyRequests Off
	ProxyPreserveHost On
	ProxyPass {{ item.ssl.source_request|default('/') }} {{ item.ssl.target_request }} disableReuse=On retry=5
	ProxyPassReverse {{ item.ssl.source_request|default('/') }} {{ item.ssl.target_request }}
	ProxyVia On

    SSLProxyEngine On
    SSLProxyCheckPeerCN Off
    SSLProxyCheckPeerExpire Off

    SSLEngine ON
    SSLCertificateFile /etc/ssl-site-certs/{{ item.ssl.cert_file }}
    SSLCertificateKeyFile /etc/ssl-site-certs/{{ item.ssl.cert_key_file }}
    SSLCertificateChainFile /etc/ssl-site-certs/{{ item.ssl.cert_chain_file }}

    ErrorLog ${APACHE_LOG_DIR}/error.log
    LogLevel warn

</VirtualHost>
{% endif  %}